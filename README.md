# All-Seeing Bot

Telegram Business бот для отслеживания изменённых и удалённых сообщений от клиентов.

---

## Возможности

- Отслеживание изменённых текстовых сообщений
- Отслеживание удалённых сообщений всех типов:
  - Текст (с содержимым)
  - Фото (с подписью если была)
  - Видео (длительность + подпись)
  - Видеокружки (длительность)
  - Голосовые сообщения (длительность)
  - Аудио (длительность + исполнитель/название)
  - Документы (имя файла + подпись)
  - Стикеры
  - GIF-анимации
  - Контакты (имя + номер)
  - Геолокации (координаты)
  - Опросы (вопрос)
  - Места (название + адрес)
  - Кубики/игры (значение)
- Поддержка нескольких владельцев
- Облачное хранение в Supabase

---

## Требования

- Python 3.10+
- Telegram Premium
- Аккаунт Supabase (бесплатный)

---

## Установка

### Шаг 1. Создать бота

1. Открыть @BotFather в Telegram
2. Отправить `/newbot`
3. Скопировать токен

### Шаг 2. Настроить Supabase

1. Зарегистрироваться на supabase.com
2. Создать проект
3. В SQL Editor выполнить:

```sql
CREATE TABLE owners (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT UNIQUE NOT NULL,
    business_connection_id TEXT UNIQUE,
    user_fullname TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    owner_id BIGINT REFERENCES owners(user_id),
    user_fullname TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, owner_id)
);

CREATE TABLE messages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    owner_id BIGINT REFERENCES owners(user_id),
    user_id BIGINT NOT NULL,
    message_id BIGINT NOT NULL,
    content_type TEXT NOT NULL DEFAULT 'text',
    message_text TEXT,
    media_duration INTEGER,
    media_file_size INTEGER,
    extra_data TEXT,
    timestamp TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(owner_id, user_id, message_id)
);

CREATE INDEX idx_messages_owner ON messages(owner_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
CREATE INDEX idx_users_owner ON users(owner_id);
```

4. В Project Settings - API скопировать URL и anon key

### Шаг 3. Установить зависимости

```bash
pip install -r requirements.txt
```

### Шаг 4. Создать config.ini

Скопировать `config_example.ini` в `config.ini` и заполнить:

```ini
[telegram]
token = "ВАШ_ТОКЕН"

[timezone]
name = "Europe/Moscow"

[settings]
language = "ru"

[supabase]
url = "https://xxx.supabase.co"
key = "eyJ..."
```

### Шаг 5. Подключить бота

1. Telegram - Настройки - Telegram Business - Чат-боты
2. Добавить бота по username
3. Включить разрешения

### Шаг 6. Запустить

```bash
python main.py
```

---

## Как работает

1. При подключении бота к Telegram Business владелец регистрируется автоматически
2. Все сообщения от клиентов сохраняются в облако
3. При редактировании/удалении владелец получает уведомление
4. Для медиа показывается тип, длительность и подпись

---

## Структура

```
all-seeing-bot/
├── main.py              # Основной файл
├── database.py          # Работа с Supabase
├── config.ini           # Конфигурация
├── config_example.ini   # Пример конфига
├── requirements.txt     # Зависимости
├── languages/
│   ├── ru.py           # Русский
│   └── en.py           # English
└── README.md
```
